<launch>
  <arg name="launch_driver" default="true"/>
  <arg name="vehicle_id" default="{{ vehicle.role_name | default('default') }}"/>
  <arg name="use_imu_corrector" default="true"/>
  
  <group>
    <push-ros-namespace namespace="imu"/>
    
{%- if 'imu' in sensors %}
{%- for imu in sensors.imu %}
    <!-- IMU: {{ imu.name }} -->
    <group>
      <!-- Topic remapping from CARLA to Autoware sensor topics -->
      <node pkg="topic_tools" exec="relay" name="{{ imu.name }}_relay" if="$(var launch_driver)">
        <param name="input_topic" value="/carla/$(var vehicle_id)/{{ imu.name }}"/>
        <param name="output_topic" value="imu_raw"/>
        <param name="type" value="sensor_msgs/msg/Imu"/>
        <param name="reliability" value="reliable"/>
      </node>
      
      <!-- IMU frame ID correction -->
      <node pkg="tf2_ros" exec="static_transform_publisher" name="{{ imu.name }}_tf_publisher"
            args="0 0 0 0 0 0 base_link {{ imu.frame_id }}">
        <param name="use_sim_time" value="true"/>
      </node>
    </group>
{%- endfor %}

    <!-- IMU Corrector for bias and noise reduction -->
    <group if="$(var use_imu_corrector)">
      <arg name="imu_raw_name" default="imu_raw"/>
      <arg name="imu_corrector_param_file" default="$(find-pkg-share {{ sensor_kit_name }}_description)/config/imu_corrector.param.yaml"/>
      
      <!-- IMU corrector node -->
      <include file="$(find-pkg-share autoware_imu_corrector)/launch/imu_corrector.launch.xml">
        <arg name="input_topic" value="$(var imu_raw_name)"/>
        <arg name="output_topic" value="imu_data"/>
        <arg name="param_file" value="$(var imu_corrector_param_file)"/>
      </include>
      
      <!-- Gyro bias estimator -->
      <include file="$(find-pkg-share autoware_imu_corrector)/launch/gyro_bias_estimator.launch.xml">
        <arg name="input_imu_raw" value="$(var imu_raw_name)"/>
        <arg name="input_odom" value="/localization/kinematic_state"/>
        <arg name="imu_corrector_param_file" value="$(var imu_corrector_param_file)"/>
      </include>
    </group>
    
    <!-- Direct passthrough if corrector is disabled -->
    <group unless="$(var use_imu_corrector)">
      <node pkg="topic_tools" exec="relay" name="imu_passthrough">
        <param name="input_topic" value="imu_raw"/>
        <param name="output_topic" value="imu_data"/>
        <param name="type" value="sensor_msgs/msg/Imu"/>
      </node>
    </group>
{%- else %}
    <!-- No IMU sensors configured -->
    <log message="Warning: No IMU sensors configured in sensor kit" severity="warn"/>
{%- endif %}
  </group>
</launch>